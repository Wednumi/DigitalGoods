@page "/offers/list"

@using DigitalGoods.Core.Specifications
@using DigitalGoods.Web.BlazorServer.Pages.Offer.OfferDisplaying;

@inherits UserIdentificationComponent

@inject IRepositoryFactory RepositoryFactory

@layout _OffersLayout

<div class="flex-fill">
    @if (_offers is null)
    {
        <LoadingMessage></LoadingMessage>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th scope="col">Preview</th>
                    <th scope="col">Name</th>
                    <th scope="col">Receive method</th>
                    <th scope="col">Amount</th>
                    <th scope="col">Price</th>
                    <th scope="col">Discount</th>
                    <th scope="col">State</th>
                    <th scope="col"></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var offer in _offers)
                {
                    <tr>
                        <td>
                            <div class="image-column">
                                <OfferPreview Offer="offer" />
                            </div>
                        </td>
                        <td>@offer.Name</td>
                        <td>@offer.ReceiveMethod</td>
                        <td>@offer.Amount</td>
                        <td>@offer.Price</td>
                        <td>@offer.Discount</td>
                        <td>@offer.State</td>
                        <td class="edit-button"><MenuItem href="@GetOfferEditLink(offer)">Edit</MenuItem></td>
                    </tr>
                }
            </tbody>
        </table>
    }
    <div class="add-button">
        <MenuItem href="offers/editor"><i class="bi bi-plus-circle-fill"></i></MenuItem>
    </div>
</div>

@code {
    private ICollection<Offer>? _offers;

    private string GetOfferEditLink(Offer offer)
    {
        return "offers/editor/" + offer.Id.ToString();
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        var repository = RepositoryFactory.CreateRepository<Offer>();
        var specification = new OffersByUserSpec(CurrentUser);
        _offers = await repository.ListAsync(specification);
    }
}
